#!1
используется
  с-префиксом надёжное: надёжное-соединение

предоставлять соединить ждать-соединения принять-соединение

интервал-отправки-пакетов = 10
ждать-пакета = 30

соединить имя-сервера номер-порта
  #:при-подключении при-подключении $ функция (причина-отключения поток-записи) пусто
  #:при-получении при-получении $ функция (объект) пусто
  #:при-изменении-состояния при-изменении-состояния $ функция (состояние) пусто
  =
  ввод = ложь
  вывод = ложь
  причина-отключения = ложь
  отключилось причина задержка =
    ввод := ложь
    вывод := ложь
    причина-отключения := причина
    при-изменении-состояния(причина)
    спать задержка
    послать-в-поток поток-соединения истина
  -- соединение
  поток-соединения = поток $ функция ()
    пусть бесконечно ()
      получить-для-потока()
      попытка
        функция (ошибка)
          отключилось ошибка 5
        значения ввод вывод := надёжное:соединить имя-сервера номер-порта
        при-подключении причина-отключения поток-записи
      бесконечно()
      
  -- чтение
  бесконечный-поток ввод $ функция ()
    прочитано =
      не-дольше ждать-пакета
        #:при-ошибке 'время-вышло
        функция ()
          прочитать ввод
    если
      (прочитано == 'время-вышло)
        отключилось 'время-вышло 0
      (не пустой?(прочитано))
        при-получении прочитано
  -- запись
  поток-записи = бесконечный-поток ввод $ функция ()
    ждать-события интервал-отправки-пакетов событие-получения()
    вывод* = вывод
    если вывод* тогда
      данные = попытаться-получить-для-потока() || '()
      написать/перенос данные вывод*
      немедленно-записать вывод*
  послать-в-поток поток-соединения истина
  поток-записи

ждать-соединения порт =
  надёжное:ждать-соединения порт

принять-соединение ожидание при-получении =
  значения ввод вывод = надёжное:принять-соединение ожидание
  -- чтение
  бесконечный-поток ввод $ функция ()
    прочитано = прочитать ввод
    если не пустой?(прочитано) тогда
      при-получении прочитано
  бесконечный-поток ввод $ функция ()
    ждать-события интервал-отправки-пакетов событие-получения()
    данные = попытаться-получить-для-потока() || '()
    написать/перенос данные вывод
    немедленно-записать вывод
  
бесконечный-поток ввод действие =
  поток $ функция ()
    пусть бесконечно ()
      ввод ?
        действие()
        спать 1
      бесконечно()
